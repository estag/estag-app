<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <link rel="apple-touch-icon" sizes="76x76" href="./assets/img/apple-icon.png">
  <link rel="icon" type="image/png" href="./assets/img/favicon.png">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
  <title>
    Estágio CI&T
  </title>
  <meta content='width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0, shrink-to-fit=no' name='viewport' />
  <!--     Fonts and icons     -->
  <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:400,700|Material+Icons" />
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/latest/css/font-awesome.min.css">
  <!-- CSS Files -->
  <link href="./assets/css/material-kit.css?v=2.0.4" rel="stylesheet" />
  <!-- CSS Just for demo purpose, don't include it in your project -->
  <link href="./assets/demo/demo.css" rel="stylesheet" />
</head>

<body class="index-page sidebar-collapse">
  <nav class="navbar navbar-transparent navbar-color-on-scroll fixed-top navbar-expand-lg" color-on-scroll="100" id="sectionsNav">
    <div class="container">
      <div class="navbar-translate">
        <a class="navbar-brand" href="https://demos.creative-tim.com/material-kit/index.html">
          Programa de estágio 2018 </a>
        <button class="navbar-toggler" type="button" data-toggle="collapse" aria-expanded="false" aria-label="Toggle navigation">
          <span class="sr-only">Toggle navigation</span>
          <span class="navbar-toggler-icon"></span>
          <span class="navbar-toggler-icon"></span>
          <span class="navbar-toggler-icon"></span>
        </button>
      </div>
    </div>
  </nav>
  <div class="page-header header-filter clear-filter purple-filter" data-parallax="true" style="background-image: url('./assets/img/bg2.jpg');">
    <div class="container">
      <div class="row">
        <div class="col-md-8 ml-auto mr-auto">
          <div class="brand">
            <h1>Terminal de acesso.</h1>
            <h3>Submeta suas repostas para avaliação do 'Professor' e aguarde orientações.</h3>
          </div>
        </div>
      </div>
    </div>
  </div>
  <div class="main main-raised">
    <div class="section section-basic">
      <div class="container">
        <div class="card card-checkin">
          <form class="form" method="" action="">
            <div class="card-header card-header-primary text-center">
              <h4 class="card-title">Abrir canal de comunicações</h4>              
            </div>
            <div class="card-body">
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text">
                    <i class="material-icons">face</i>
                  </span>
                </div>
                <select id="groups" class="form-control">
                  <option selected value="0">Escolha um grupo...</option>                    
                </select>
              </div>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text">
                    <i class="material-icons">launch</i>
                  </span>
                </div>                
                <select id="rooms" class="form-control">
                  <option selected value="0">Escolha uma sala...</option>                    
                </select>
              </div>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text">
                    <i class="material-icons">lock_outline</i>
                  </span>
                </div>
                <input type="secret" class="form-control" placeholder="Segredo...">
              </div>
            </div>
            <div class="footer text-center">
              <input type="button" id="checkin" class="btn btn-primary btn-lg" value="Iniciar">
            </div>
          </form>
        </div>
        <div class="card card-console" style="display: none">
          <form class="form" method="" action="">
            <div class="card-header card-header-primary text-center">
              <h4 class="card-title">Desafio <span id="room_name">{{NOME_SALA}}</span></h4>              
            </div>
            <div class="card-body">
              <div class="type-response" style="font-family: 'Courier New', Courier, monospace; font-size: 20px;">
                <span class="type-container-console"></span>
              </div>              
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text">
                    <i class="material-icons">question_answer</i>
                  </span>
                </div>
                <select id="questions" class="form-control">
                  <option selected value="0">Selecione uma questão...</option>
                </select>
              </div>
              <div class="input-group">
                <div class="input-group-prepend">
                  <span class="input-group-text">
                    <i class="material-icons">code</i>
                  </span>
                </div>
                <input type="text" id="answer-group" class="form-control" placeholder="Resposta...">
              </div>
            </div>
            <div class="footer text-center">
              <input type="button" id="answer" class="btn btn-primary btn-lg" value="Checar resposta">
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>
  <footer class="footer" data-background-color="black">
    <div class="container">
      <div class="copyright float-right" style="display: none">
        &copy;
        <script>
          document.write(new Date().getFullYear())
        </script>, made with <i class="material-icons">favorite</i> by
        <a href="https://www.creative-tim.com" target="_blank">Creative Tim</a> for a better web.
      </div>
    </div>
  </footer>
  <!--   Core JS Files   -->
  <script src="./assets/js/core/jquery.min.js" type="text/javascript"></script>
  <script src="./assets/js/core/popper.min.js" type="text/javascript"></script>
  <script src="./assets/js/core/bootstrap-material-design.min.js" type="text/javascript"></script>
  <script src="./assets/js/plugins/moment.min.js"></script>
  <!--	Plugin for the Datepicker, full documentation here: https://github.com/Eonasdan/bootstrap-datetimepicker -->
  <script src="./assets/js/plugins/bootstrap-datetimepicker.js" type="text/javascript"></script>
  <!--  Plugin for the Sliders, full documentation here: http://refreshless.com/nouislider/ -->
  <script src="./assets/js/plugins/nouislider.min.js" type="text/javascript"></script>
  <!--	Plugin for Sharrre btn -->
  <script src="./assets/js/plugins/jquery.sharrre.js" type="text/javascript"></script>
  <script src="https://cdn.jsdelivr.net/npm/typeit@5.10.6/dist/typeit.min.js" type="text/javascript"></script>
  <script src="./assets/js/plugins/jquery.blockUI.js" type="text/javascript"></script>
  <!-- Control Center for Material Kit: parallax effects, scripts for the example pages etc -->
  <script src="./assets/js/material-kit.js?v=2.0.4" type="text/javascript"></script>
  <script>
    $(document).ready(function() {

      const BASE_URL = "http://cit-scapetech-api.herokuapp.com/api";
      const STORAGE_KEY_GROUP = "currentGroup";
      
      var currentGroup = JSON.parse(sessionStorage.getItem(STORAGE_KEY_GROUP));
      
      $.get(BASE_URL + "/groups", function(data, status){
        data.forEach(element => {
          $('#groups').append($('<option>', {
              value: element.id,
              text: element.group_name
          }));
        })
      })      

      $.get(BASE_URL + "/rooms", function(data, status){
        data.forEach(element => {
          $('#rooms').append($('<option>', {
              value: element.id,
              text: element.room_name
          }));
        })
      });

      $("#answer").click(function(){
        
        if($('#answer').val() == 0){
          $.blockUI({ 
              message: '<div class"alert alert-success" style="margin: 20px"><div class="container"><b>Questão é obrigatória:</b> Por favor informe a questão que está validando.</div></div>',               
              timeout: 2000  
          }); 
          return;
        }

        if($('#answer-group').val() == 0){
          $.blockUI({ 
              message: '<div class"alert alert-success" style="margin: 20px"><div class="container"><b>Resposta é obrigatória:</b> Por favor informe a resposta da questão.</div></div>',               
              timeout: 2000  
          }); 
          return;
        }

        var currentGroup = JSON.parse(sessionStorage.getItem(STORAGE_KEY_GROUP));        

        var objectAnswer = {
          question: parseInt($("#questions").val()),
          answer: $("#answer-group").val(),
          group: currentGroup.group,
          room: currentGroup.room
        }
        
        $.ajax({
          url: BASE_URL + '/group/answer',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify(objectAnswer),
          dataType: 'json',
          success: function(data, status, xhr){ 

            if(xhr.status == 200){
              addConsole('Você errou hahahahahha...');
            }else if(xhr.status == 201){
              addConsole('tudo de boa... tu é o cara!');
            }

          }
        });                
        
      });

      $("#checkin").click(function(){
        
        if($('#groups').val() == 0){
          $.blockUI({ 
              message: '<div class"alert alert-success" style="margin: 20px"><div class="container"><b>Grupo é obrigatório:</b> Por favor informe o seu grupo para inciar.</div></div>',               
              timeout: 2000  
          }); 
          return;
        }

        if($('#rooms').val() == 0){
          $.blockUI({ 
              message: '<div class"alert alert-success" style="margin: 20px"><div class="container"><b>Sala é obrigatória:</b> Por favor informe a sala onde você está para inciar.</div></div>',               
              timeout: 2000  
          }); 
          return;
        }

        var objectCheckin = {
          group: $("#groups").val(),
          room: $("#rooms").val()
        }

        $.ajax({
          url: BASE_URL + '/group/checkin',
          type: 'POST',
          contentType: 'application/json',
          data: JSON.stringify(objectCheckin),
          dataType: 'json',
          success: function(data){ 
         
            var objectCurrentGroup = {
              group_name: $("#groups option:selected").text(),
              room_name: $("#rooms option:selected").text()
            };

            $.extend(objectCurrentGroup, objectCheckin);            

            sessionStorage.setItem(STORAGE_KEY_GROUP, JSON.stringify(objectCurrentGroup));

            startRoom();

          }
        });
      });

      startRoom = function(){
        
        $('.card-console').show();
        $('.card-checkin').hide();

        var currentGroup = JSON.parse(sessionStorage.getItem(STORAGE_KEY_GROUP));        

        $.get(BASE_URL + "/room/qa/" + currentGroup.room, function(data, status){
          data.forEach(element => {
            $('#questions').append($('<option>', {
                value: element.question_number,
                text: element.question_number + " - " + element.question_text + " - (pontos " + element.num_points + ")"
            }));
          })
        });

        $("#room_name").text(currentGroup.group_name + " - " + currentGroup.room_name);

      };

      addConsole = function(message){

        var count = parseInt(sessionStorage.getItem("countMessage"));

        if(isNaN(count)){
          count = 1;
        }
        
        $(".type-container-console").append($('<p class="type-it message-'+ count +'"></p>'));

        new TypeIt('.message-' + count, {
          strings: message,
          beforeString: function(instance){
            var $this = $(".message-" + count);
            
            $this.scrollTop = 1000;

          },
          afterComplete: function (instance) {
            instance.destroy();
          }
        });

        count++;

        console.log(count);

        sessionStorage.setItem("countMessage", count);

      }

      if(currentGroup != null && currentGroup.group){
        startRoom();
      }

    });
  </script>
</body>

</html>